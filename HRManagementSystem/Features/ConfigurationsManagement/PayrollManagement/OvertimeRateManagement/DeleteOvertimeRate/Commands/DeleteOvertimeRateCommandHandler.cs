using HRManagementSystem.Data.Models.ConfigurationsModels;

namespace HRManagementSystem.Features.ConfigurationsManagement.PayrollManagement.OvertimeRateManagement.DeleteOvertimeRate.Commands
{
    public sealed class DeleteOvertimeRateCommandHandler :
         RequestHandlerBase<DeleteOvertimeRateCommand, RequestResult<bool>, OvertimeRate, Guid>
    {
        private readonly ILogger<DeleteOvertimeRateCommandHandler> _logger;

        // ??? ???? repository ??? ?????? ?? ???? ????? (????? payroll items) ???? ?? parameter ???.
        public DeleteOvertimeRateCommandHandler(
            RequestHandlerBaseParameters<OvertimeRate, Guid> parameters,
            IMapper mapper,
            ILogger<DeleteOvertimeRateCommandHandler> logger)
            : base(parameters)
        {
            _logger = logger;
        }

        public override async Task<RequestResult<bool>> Handle(DeleteOvertimeRateCommand request, CancellationToken ct)
        {
            try
            {
                // 1. ??? ?????? (???? ????????? ?????? ??? ??? ?????)
                var entity = await _generalRepo.GetByIdAsync(request.Id);

                if (entity == null)
                {
                    return RequestResult<bool>.Failure(
                        "???? ????? ??????? ??? ????? ?? ?? ???? ??????.",
                        ErrorCode.NotFound);
                }

                // 2. ???? ?? ???? ????? ?? ????? ???? (??????? ???? ???? ??)
                // ????: ??? ????? ???? PayrollItems ???? FK ??? OvertimeRateId
                // ??? ?????? ???? ??? ?? ???? ?????? ???????? ?? ??????? ????????.
                //
                // if (await _someRepo.CheckAnyAsync(pi => pi.OvertimeRateId == request.Id, ct))
                // {
                //     return RequestResult<bool>.Failure(
                //         "?? ???? ??? ??? ?????? ???? ?????? ?? ????? ??????? ?? ????? ???????.",
                //         ErrorCode.Conflict);
                // }

                // 3. ???? soft delete ??? ???????????? ?????
                var deleted = await _generalRepo.SoftDeleteAsync(request.Id, ct);

                if (!deleted)
                {
                    _logger.LogWarning("SoftDeleteAsync returned false for OvertimeRate.Id={Id}", request.Id);
                    return RequestResult<bool>.Failure(
                        "??? ????? ???? ????? ???????. ???? ??? ???? ?? ????? ?? ?????.",
                        ErrorCode.BadRequest);
                }

                // 4. ???? ??? ??? ?????? ?????? ??? ?????: ????? ?????? ????? ?????? ??? ???...
                // ???? ?????? ?????? ?????:
                // _cache.Remove("OvertimeRates:All");
                //
                // ?? ??? ?????:
                // await _mediator.Publish(new OvertimeRateChangedNotification(request.Id), ct);

                // 5. ????? ??????
                return RequestResult<bool>.Success(true, "?? ????? ???? ????? ??????? ?????.");
            }
            catch (OperationCanceledException)
            {
                // ????? ????? ?????
                _logger.LogInformation("DeleteOvertimeRateCommand cancelled for Id={Id}", request.Id);
                throw;
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "Error while deleting OvertimeRate Id={Id}", request.Id);
                return RequestResult<bool>.Failure(
                    "??? ??? ??? ????? ????? ?????? ??? ???? ????? ???????.",
                    ErrorCode.BadRequest);
            }
        }
    }
}

